<!DOCTYPE html>
<html>
<head>
  <title>Bike Tracker</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Leaflet Fullscreen Plugin CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.css" />
  <!-- Routing Machine CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

  <style>
    body,html { margin:0; padding:0; height:100%; }
    #map { height: 100%; width: 100%; display:none; }
    .time-control {
      background: rgba(255,255,255,0.8);
      padding: 5px 10px;
      font-weight: bold;
      border-radius: 5px;
    }
    /* Login overlay */
    #login-screen {
      display:flex;
      justify-content:center;
      align-items:center;
      height:100%;
      background:#f0f0f0;
    }
    #login-box {
      background:white;
      padding:20px;
      border-radius:10px;
      box-shadow:0 0 10px rgba(0,0,0,0.2);
      text-align:center;
    }
    #logout-btn {
      position:absolute;
      top:10px;
      right:10px;
      z-index:1000;
      padding:5px 10px;
      background:#f44336;
      color:white;
      border:none;
      border-radius:5px;
      cursor:pointer;
    }
  </style>
</head>
<body>
<div id="login-screen">
  <div id="login-box">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Enter your name"><br><br>
    <button id="login-btn">Login</button>
  </div>
</div>

<button id="logout-btn" style="display:none;">Logout</button>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/leaflet-polylinedecorator"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, set, remove, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDX-qTY_wvPp7nNAbWR_-OAWr8sn_yO3oM",
  authDomain: "bike-tracker-ad774.firebaseapp.com",
  databaseURL: "https://bike-tracker-ad774-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "bike-tracker-ad774",
  storageBucket: "bike-tracker-ad774.appspot.com",
  messagingSenderId: "107735877385",
  appId: "1:107735877385:web:a738f9caa1987d470bf5d8",
  measurementId: "G-CVFHJL80DK"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- Variables ---
let visitorId = null;
let watchId = null;

// --- Login logic ---
document.getElementById("login-btn").onclick = () => {
  const username = document.getElementById("username").value.trim();
  if(!username) return alert("Enter a name!");

  visitorId = "visitor-" + username + "-" + Date.now();

  // Show map + logout
  document.getElementById("login-screen").style.display = "none";
  document.getElementById("map").style.display = "block";
  document.getElementById("logout-btn").style.display = "block";

  initMap();
  startTracking();
};

// --- Logout logic ---
document.getElementById("logout-btn").onclick = async () => {
  if(visitorId){
    await remove(ref(db,"visitors/"+visitorId));
  }
  if(watchId !== null){
    navigator.geolocation.clearWatch(watchId);
  }

  // Reset UI
  document.getElementById("map").style.display = "none";
  document.getElementById("logout-btn").style.display = "none";
  document.getElementById("login-screen").style.display = "flex";
};

// --- Map + features ---
let map, myIcon, markers={}, firstUpdate=true;

function initMap(){
  map = L.map('map',{ fullscreenControl:true }).setView([47.126,24.483],13);
  map.on('fullscreenchange', () => map.invalidateSize());

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

  // Time control
  var timeControl = L.control({position:'topleft'});
  timeControl.onAdd = function(map){
    this._div = L.DomUtil.create('div','time-control');
    this.update();
    return this._div;
  };
  timeControl.update = function(){
    const now = new Date();
    const timeStr = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    this._div.innerHTML = `<b>${timeStr}</b>`;
  };
  timeControl.addTo(map);
  setInterval(()=>timeControl.update(),60000);

  myIcon = L.icon({ iconUrl:'pfp.jpg', iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32] });

  // Listen for other visitors
  onValue(ref(db,'visitors'), snapshot=>{
    const data = snapshot.val() || {};
    const now = Date.now();

    // Remove stale markers
    for(const id in markers){
      const visitorData = data[id];
      if(!visitorData || !visitorData.ts || (now - visitorData.ts > 30000)){
        map.removeLayer(markers[id]);
        delete markers[id];
      }
    }

    // Add/update markers
    for(const id in data){
      const visitor = data[id];
      const lastUpdateStr = new Date(visitor.ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      if(!markers[id]){
        markers[id] = L.marker([visitor.lat,visitor.lon],{icon:myIcon})
                        .addTo(map)
                        .bindPopup(`${id}<br>Speed: ${visitor.speed?visitor.speed+" km/h":"N/A"}<br>at ${lastUpdateStr}`);
      } else {
        markers[id].setLatLng([visitor.lat,visitor.lon])
                   .bindPopup(`${id}<br>Speed: ${visitor.speed?visitor.speed+" km/h":"N/A"}<br>at ${lastUpdateStr}`);
      }
      if(firstUpdate){
        map.setView([visitor.lat,visitor.lon],15);
        firstUpdate=false;
      }
    }
  });
}

// --- Location tracking ---
function startTracking(){
  if(navigator.geolocation){
    watchId = navigator.geolocation.watchPosition(pos=>{
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const speedKMH = pos.coords.speed ? (pos.coords.speed*3.6).toFixed(1) : null;
      set(ref(db,`visitors/${visitorId}`),{lat,lon,speed:speedKMH,ts:Date.now()});
    }, err=>console.error("Geolocation error:",err), {enableHighAccuracy:true});
  }
}
</script>
</body>
</html>
